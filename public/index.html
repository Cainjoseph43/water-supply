<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <style>
      body, html{
        width: 100%;
        height: 100%;
        margin: 0;
      }
      stacked-bar-chart{
        width: 100%;
        display: block;
      }
    </style>
  </head>
  <body ng-app="myApp" ng-controller="MainCtrl">
      <stacked-bar-chart ng-style="{height: 100 / reservoirs.length + '%'}" data="reservoir.data" max="max" ng-repeat="reservoir in reservoirs"></stacked-bar-chart>
  </body>
    <script src="d3.js" charset="utf-8"></script>
    <script src="angular.js"></script>
    <script>
var app = angular.module('myApp', [])
app.controller('MainCtrl', function($scope, $window){
  angular.element($window).on('resize', function(){ $scope.$apply() })
  $scope.reservoirs = []
  d3.csv('drought.csv', function(row){
    row.year = Number(row.date.split('/')[1])
    row.month = Number(row.month)
    var month = row.month.toString()
    if(month.length === 1) month = '0' + month
    row.date = row.year + '-' + month
    Object.keys(row).forEach(function(header){
      if(header === 'date' || header === 'month' || header === '') return
      row[header] = Number(row[header])
    })
    return row
  }, function(err, data){
    if(err) throw err
    // format the layers
    function stackedData(reservoirs){
      return reservoirs.map(function(name){
        return {
            name: name
          , values: data.filter(function(row){
            return true // dont filter
            // return row.date >= '2013-01'
          }).map(function(row){ return { x: row.date, y: row[name] } })
        }
      })
    }
    // reservoir names
    var names = Object.keys(data[0])
      .filter(function(name){
        return name !== 'date' && name !== 'month' && name !== 'year' })

    $scope.reservoirs = names.map(function(name){
      return { name: name, data: stackedData([name]) }
    })
    $scope.max = d3.max($scope.reservoirs, function(reservoir){
      return d3.max(reservoir.data[0].values, function(value){
        return value.y
      })
    })
    $scope.$apply()
  })
})
    </script>
    <script src="directives/stacked-bar-chart.js" charset="utf-8"></script>
</html>