<!DOCTYPE html>
<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <title></title>
    <style>
      html, body{
        width: 100%;
        height: 100%;
      }
      body{
        margin: 0;
        background-color: white;
        color: black;
        font-family: 'Open Sans', sans-serif;
      }
      water-map{
        width: 100%;
        height: 100%;
        display: block;
        overflow: hidden;
        shape-rendering: crispEndges;
      }
      water-map circle{
        opacity: 0.5;
      }
      water-map path{
        fill: none;
        stroke: #999;
        opacity: 0.5;
      }
      circle{
        fill: #999;
      }
      circle.level{
        fill: blue;
      }
      input[type="range"]{
        width: 100%;
      }
      .map-container{
        /*border: 1px solid rgba(255, 0, 0, 1);*/
        margin: auto;
        display: block;
        width: 700px;
        height: 700px;
        position: relative;
        box-sizing: border-box;
      }
      .detail{
        position: absolute;
        width: 400px;
        top: 90px;
        right: 0;
      }
      .detail .title{
        text-align: left;
        font-size: 20px;
      }
      reservoir-detail{
        width: 400px;
        height: 300px;
        display: block;
        /*border: 1px solid red;*/
        box-sizing: border-box;
      }
      reservoir-detail .years line{
        stroke: #444;
        shape-rendering: crispEdges;
      }
      reservoir-detail .years{
        font-size: 14px;
      }
      reservoir-detail .axis-x{
        font-size: 8px;
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
      }
      reservoir-detail .axis-x path{
        stroke: none;
      }
      reservoir-detail .axis-x text{
        fill: black;
        stroke: none;
      }
      reservoir-detail rect{
        fill: blue;
        opacity: 0.8;
      }
      water-map .reservoirs{
        cursor: pointer;
      }
    </style>
  </head>
  <body ng-app="myApp" ng-controller="MainCtrl">
    <div class="map-container">
      <h2>{{ year }} - {{ month }}</h2>
      <button ng-model="playing" ng-click="playing = !playing">{{ playing ? 'pause' : 'play' }}</button>
      <input type="range" ng-model="now" min="0" max="{{history.length - 1}}">
      <water-map
        reservoirs="reservoirs"
        history="history"
        now="now"
        selected-reservoir="reservoir"
        shapefile="shapefile">
      </water-map>
      <div class="detail">
        <h1 class="title"> {{reservoir.station}}</h1>
        <span>{{reservoir.capacity }}</span>
        <reservoir-detail reservoir="reservoir" year="year" month="month"></reservoir-detail>
      </div>
    </div>
  </body>
    <script src="d3.js" charset="utf-8"></script>
    <script src="topojson.v1.js" charset="utf-8"></script>
    <script src="angular.js"></script>
    <script>
var app = angular.module('myApp', [])
app.filter('reverse', function() {
  return function(items) {
    if (!angular.isArray(items)) return false
    return items.slice().reverse()
  }
})
app.controller('MainCtrl', function($scope, $window, $interval){
  $scope.d3 = d3
  angular.element($window).on('resize', function(){ $scope.$apply() })
  $scope.reservoirs = []
  $scope.reservoir
  $scope.now = 0
  $scope.playing = false
  var interval
  $scope.$watch('playing', function(playing){
    if(playing){
      var prev_now = $scope.now
      interval = $interval(function(){
        if($scope.now !== prev_now){
          // something other than this timer updated `now`. we should stop
          // auto playing
          $interval.cancel(interval)
          $scope.playing = false
          return
        }
        $scope.now++
        if($scope.now >= $scope.history.length) $scope.now = 0
        prev_now = $scope.now
      }, 500)
    }else{
      $interval.cancel(interval)
    }
  })
  $scope.$watch('now', update_month_year)
  function update_month_year(){
    var now = $scope.now
    if(!$scope.history) return
    $scope.year = $scope.history[now].year
    $scope.month = $scope.history[now].month
  }
  $scope.maxReservoir = function(reservoir){
    if(!reservoir) return
    return d3.max(reservoir.data, function(d){
      return d3.max(d.values, function(d){ return d.value })
    })
  }
  d3.csv('data/reservoirs.capacities.csv', function(row){
    row.elev = Number(row.elev)
    row.latitude = Number(row.latitude)
    row.longitude = Number(row.longitude)
    row.capacity = Number(row.capacity)
    // convert station names to sentence case instead of all caps
    row.station = row.station.split(' ').map(function(word){
      return word.toLowerCase().split('').map(function(l, i){
        if(i === 0) return l.toUpperCase(); return l
      }).join('')
    }).join(' ')
    return row
  }, function(err, reservoirs){
    if(err) throw err
    $scope.$apply(function(){
      $scope.reservoirs = reservoirs
      $scope.reservoir = reservoirs[6]
    })
    d3.csv('data/drought.csv', function(row, i){
      delete row[''] // get rid of this empty column property
      row.year = Number(row.date.split('/')[1])
      row.month = Number(row.month)
      var month = row.month.toString()
      if(month.length === 1) month = '0' + month
      row.date = row.year + '-' + month
      var obj = {} // temp object to hold reservoir data
      Object.keys(row).forEach(function(header){
        var non_reservoir_headers = ['date', 'month', 'year', '', 'capacity']
        if(non_reservoir_headers.indexOf(header) !== -1) return
        // convert to numbers and namespace the reservoirs
        obj[header] = Number(row[header])
        delete row[header]
      })
      row.reservoirs = obj
      /*
      row === {
        date:, month:, year:, reservoirs: {sha:10, led:30, ...}
      }
      */
      return row
    }, function(err, history){
      if(err) throw err
      $scope.$apply(function(){
        $scope.now = 0
        $scope.playing = true
        // just just data for the last 5 years
        history = history.filter(function(d){ return d.year >= 2010 })
        $scope.history = history
        update_month_year()
        $scope.reservoirs = reservoirs
          .map(function(reservoir){
            // get _all_ the historic data for this reservoir
            var data = history.map(function(step){
              return {
                  value: step.reservoirs[reservoir.id]
                , year: step.year
                , month: step.month
              }
            })
            // group the historic data by year
            var data = d3.nest().key(function(d){ return d.year }).entries(data)
            reservoir.data = data
            return reservoir
          })
      })
    })
  })
  d3.json('data/counties.topojson', function(err, shapefile){
    if(err) throw err
    $scope.shapefile = shapefile
    $scope.$apply()
  })
})
    </script>
    <script src="directives/bar-chart.js"></script>
    <script src="directives/water-map.js"></script>
    <script src="directives/reservoir-detail.js"></script>
</html>